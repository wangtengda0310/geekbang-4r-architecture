# 1
#### 总体架构思路
10w

> 注册登录 -》 加好友 -》 聊天

> 基本
> 每个用户都会通过算法生成非对称的公钥和私钥
> 用户发送的消息会通过公钥加密，接收用户的消息使用自己的私钥解密
> 只能创建一对一聊天
> 聊天消息“阅后即焚”，最多只保留60分钟
> 无需使用手机号注册
> 每个用户最多20各好友

> 老板要求3年1000万

#### 存储架构设计
[注册] 十万用户注册信息
[登录] 由于是新产品，假设10w注册，日活40%，每天登录4w
[加好友] 每个活跃用户最多20各好友，好友关系书4w*20=80万关系数
[聊天] 假设每个活跃用户每天向5位好友发送100条消息，消息数量为4w*5*100=2000万，且“阅后即焚”数据当天基本被删除，所以写入、夺取、删除次数都可以估算为2000万

10万用户注册信息，4万登录请求，80万关系数据\
```plantuml
title: MySql主备（用户数据+关系数据）
mysql（主） --|> mysql（备）: 数据复制
```
Redis主备聊天数据
```plantuml
Master ==> Slave（备）: 数据复制
```

MySQL为什么不用主从读写分离？redis为什么不读写分离？
存储性能要求不高，主备可满足需求

#### 计算架构设计
【注册】1年达到10w注册，tps低
【登录】由于是新产品，设计10w注册用户，每天活跃40%，假设登录实践集中在早晚4小时，tps均值4w/14400 = 3
【加好友】每个活跃用户最多20各好友，好友关系数4w*20=80万数据，按照1年计算，tps可忽略不计
【聊天】假设每个活跃用户每天向5位好友发送100条消息，则消息数量为4w*5*100=2000w，假设每天集中在早中晚3各时段6小时内
- 发送消息tps：2000w/（3600*6）=1000
- 读取消息qps=发送消息tps；删除消息tps=发送消息tps

负载均衡
```

                App ----------------- dns
                 |
                 v
            virtual ip
    nginx<----keep alive--->nginx
                 |
                 v
            业务服务器集群
    server  server  server  server
```
缓存架构
```

                                                      +-----------+
                        +-------------- 应用1 ----->  |           |
                        |                             |           | --------> server
                        |                             |           |
iPhone ----------> web容器缓存                        | 分布式缓存 | --------> server
    |                   |                             |           |
    +----> App缓存      |                             |           | ---------> server
                        +-------------- 应用2 ----->  |           |
                                                      +-----------+
```

#### 其他架构设计

可扩展系统
1. 单体系统： IM后台
2. 2各服务：用户服务 聊天服务
3. 3各服务：用户服务 关系服务 聊天服务  （不可行）

高可用架构设计 - 同城数据灾备
<pre>
          idc-1                          idc-2
        业务服务器
           /\
    读写  /  \ 读写（人工切换）
        m/    \
        v      v
    主机 -----> 备机                     备机
     |  数据复制                           ^
     +-------------------------------------+

</pre>

---
# 2
#### 业务背景
用户活跃数量上升到60多万，很快过百万，准备启动架构演进
【公司背景变化】
1. 技术团队从10人增长到30人，后端18个，前端4个，Android4个，ios4个
2. 2名增长黑客数据分析师

业务基本场景
> 注册登录 ----> 加好友 ----> 聊天 ----> `群聊`

> 基本
> 每个用户都会通过算法生成非对称的公钥和私钥
> 用户发送的消息会通过公钥加密，接收用户的消息使用自己的私钥解密
> 只能创建一对一聊天
> 聊天消息“阅后即焚”，最多只保留60分钟
> 无需使用手机号注册
> 每个用户最多20各好友
>> 增加群聊功能，每个私密群聊限制人数为5人

#### 总体架构设计
百万 千万

【注册】百万用户注册信息
【登录】百万注册用户，每天活跃40%，登录时读取用户信息每天40万qps
【加好友】每个活跃用户最多20个好友，好友关系数40万*20=800万数据
【聊天】假设每个活跃用户每天向5为好友发送100条信息，则消息数量为40万*5*100=2亿，数据当天删除，写入+读取+删除=6亿
【群聊】假设活跃用户中10%发起群聊，平均每人每天2个，每个群聊每天200条消息
- 消息写入：40万*10%*2（群聊）*200（消息）=1600万数据
- 消息删除次数：等于消息写入数据量
- 消息读取数量：1600万*5（每个群最多5人）=8000万/天

#### 存储架构设计
100万用户注册信息，40万登录请求，800万关系数据
MySql主备（用户数据+关系数据）
```planyuml
mysql（主） ==> mysql（备）: 数据复制
```

聊天：6亿读写请求/天；群聊：1亿读写请求/天
Redis Cluster（聊天数据）
```
Shard-1        shard-2
```

#### 计算架构设计
【注册】每日新用户不到1万
【登录】假设百万注册用户，每天活跃40%假设登录实践集中在早晚4小时，登录tps均值：40万/14400=30
【加好友】每个活跃用户最多20个好友，好友关系数40万*20=800万数据，按年计算，tps可以忽略不计
【聊天】假设活跃用户每天向5位好友发送100条消息，消息数量为：40万*5*100=2亿，假设每天集中在早中晚6小时，tps：2亿/（3600*6）*3（发+收+删）=30000
【群聊】假设活跃用户10%发起群聊，平均每人每天2个，每个群聊每天200条消息
- 消息写入和删除次数：40万*10%*2*200*2（写+删）/（3600*6） = 1600tps

负载均衡
<pre>
  
                App ----------------- dns
                 |
                 v
            virtual ip
    nginx<----keep alive--->nginx   ：Tps+Qps大约4万
                 |
                 v
            业务服务器集群           ：服务器数量比十万用户规模架构要多很多
    server  server  server  server

</pre>
100万用户增长到300万
<pre>
                App ----------------- dns
     IDC         |
                 v
            virtual ip
    LVS <----keep alive---> LVS
                 |
                 v
        业务服务器集群（加机器）
    server  server  server  server
</pre>
缓存架构
<pre>
                                                     +-----------+
                        +-------------- 应用1 -----> |            |
                        |                           |            | --------> server
                        |                           |            |
iPhone ----------> web容器缓存                       | 分布式缓存 | --------> server
    |                   |                           |            |
    +----> App缓存      |                           |            | ---------> server
                        +-------------- 应用2 -----> |           |
                                                     +-----------+
</pre>
#### 其他架构设计

可扩展架构设计 - 微服务拆分

五个服务：用户服务 关系服务 聊天服务 群聊服务 综合服务
微服务基础设施：服务注册 服务发现 服务路由 服务网关

高可用架构设计 - 同城数据灾备
<pre>
  
                同城双中心（灾备->双活）

          idc-1                                  idc-2

  server server server ----业务切换---->  server server server 


  server server server ----数据同步---->  server server server 

</pre>
大数据架构
spark
- 功能强大，可扩展性强
- 数据分时不会用
- 支持后续的推荐等业务
click house
- 兼容sql，维护简单
- 性能强筋，olap分析平台

结构需要解决的核心复杂度
十万：快速验证
百万：快速扩展

|存储架构|MySQL主备 redis主备|mysql主备 redis cluster|redis主备->redis cluster|
|:--:|:--:|:--:|:--:|
|计算架构|台nginx负载均衡 三级缓存|2台nginx/lvs负载均衡 三级缓存|1.可能要随着用户量增长重构为lvs 2.缓存的应用范围可能会扩大|
|可扩展架构|单体/2服务|拆分为5个服务 微服务核心基础设施|单体/2服务->微服务|
|高可用|MySQL主备跨机房复制 只保证基础数据不丢失|同城双中心|单机房->同城双中心（灾备->双活）|
|大数据架构|无|click house|click house做olap分析|
|架构本质复杂度|快速验证（核心需求）|快速扩展（辅助需求）|核心需求->辅助需求|

---
# 3
#### 业务背景
两年千万，准备架构演进
【公司背景变化】
- 技术团队从30人增长到100人，覆盖完整技术栈，包括大数据、风控安全等
- 由于公司的业务发展良好，证明了业务模式，业内已经有几家竞争对手出现了

业务基本场景
> 注册登录 ----> 加好友 ----> 聊天 ----> 群聊 ----> `支付`

> 基本
> 每个用户都会通过算法生成非对称的公钥和私钥
> 用户发送的消息会通过公钥加密，接收用户的消息使用自己的私钥解密
> 只能创建一对一聊天
> 聊天消息“阅后即焚”，最多只保留60分钟
> 无需使用手机号注册
> 每个用户最多20各好友
> 增加群聊功能，每个私密群聊限制人数为5人
>> 增加支付功能，用于2个私聊用户之间转账或者红包


#### 总体架构思路
<pre>
  
                            总体架构（p9）
                                |
+--------------------------------------------------+
v                       v                          v
业务域A（p8）       业务域B（p8）           业务域C（p8）
微服务A 微服务B    微服务A 微服务B         微服务A 微服务B
    微服务C           微服务C                 微服务C

                            基础技术
运维平台 测试平台 存储平台 大数据平台 全链路压测 全链路跟踪 异地多活 。。。。


</pre>
1. 不同架构师的职责有什么区别？
总架构师（p9）的核心职责：1 划分业务域 2 基础技术平台完善
业务域架构时（p8）的核心职责：1 划分业务域内的微服务 2 按照用户规模设计架构
2. 感觉总架构师要运维、测试、大数据都要东，怎么做到？
每个技术域需要一个p8的负责，但总架构师确实每个领域都要懂一些（技术广度）
例如：全链路压测什么时候实现？用什么方案？需要总架构师一起决策
3. 各个业务域内的架构，总架构师是不是不需要关注？
基本上是的，除非某个域问题很多，例如线上质量问题，开发效率问题等。
4. 业务域划分总是架构师划分就可以了吗？
实际上是有老板、业务方、总架构师一起讨论去顶的，不单是一个技术决策，还是一个权力决策。
#### 业务域划分
业务域划分粒度
<pre>
  
                                                             业务域（p8） p8->3个p7
                                                                         |
                        +------------------------------------------------+-------------------------------------------+
                        v                                                v                                           v
            子域（p7+）p7+->3个p7/p6+                                  子域（p7）                                  子域（p7）
                        |                                                |                                           |
    ------------------------------------------------------------------------------------------------------------------------------------
    V                   V             V              V                   V             V              V              V                 V
微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7) 微服务1(p6+/p7)


</pre>
用户域： 用户 关系 vip
聊天域：单聊 群聊 红包
综合域：营销 广告 支付

#### 基础技术建设
“四化建设”

规范化（统一的各类规范）  ---->   平台化（基于规范实现的统一平台）  ---->   自动化（统一平台自动实现各类功能）  ---->   可视化（状态、功能、操作等可视化）
例如：
> 日志规范
> 开发框架
> rpc框架
> 接口规范
> 代码管理规范

> 测试平台
> 运维平台
> 大数据平台

> 接口自动化测试
> 全链路压测
> 故障自动分析

> 系统状态可是化
> 任务管理可视化
> 任务执行可视化


“四个核心平台”
- 运维平台：配置 部署 监控 应急
- 测试平台：用例管理 资源管理 任务管理 数据管理
- 存储平台：sql平台 nosql平台 小文件存储 大文件存储
- 大数据平台：离线处理 在线处理 推荐系统
#### 其他架构设计
单机房内负载均衡
<pre>

                                   App -----------------> dns
IDC                                 |
                                    v
                                virtual ip
                        F5 <----keep alive---> F5
                       /                        \
                      v                          v
  业务域A服务器集群（nginx+服务网关）             业务域A服务器集群（nginx+服务网关）
               nginx                                        nginx
   server  server  server  server                 server  server  server  server
</pre>
缓存架构
<pre>
                                                     +-----------+
                        +-------------- 应用1 -----> |            |
                        |                           |            | --------> server
                        |                           |            |
iPhone ----------> web容器缓存                       | 分布式缓存 | --------> server
    |                   |                           |            |
    +----> App缓存      |                           |            | ---------> server
                        +-------------- 应用2 -----> |           |
                                                     +-----------+
</pre>
高可用架构设计
同城双活
异地双活

架构要解决的核心复杂度
十万：快速验证（核心需求）
百万：快速扩展（辅助需求）
千万：全面完善（基础技术）


|存储架构|MySQL主备 redis主备|mysql主备 redis cluster|存储平台|存储系统->存储平台|
|:--:|:--:|:--:|:--:|:--:|
|计算架构|台nginx负载均衡 三级缓存|2台nginx/lvs负载均衡 三级缓存|F5+nginx负载均衡 三级缓存|nginx/lvs->f5|
|可扩展架构|单体/2服务|拆分为5个服务 微服务核心基础设施|业务域|微服务->业务域|
|高可用|MySQL主备跨机房复制 只保证基础数据不丢失|同城双中心|同城双活/异地双活|同城双中心->同城双活/异地双活|
|大数据架构|无|click house|大数据平台|click house -> 大数据平台|
|架构本质复杂度|快速验证（核心需求）|快速扩展（辅助需求）|全面完善（基础技术）|需求->技术|
